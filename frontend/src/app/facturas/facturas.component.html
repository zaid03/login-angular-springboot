<div class="facturas-page">
    <div 
        class="sidebar-backdrop" 
        *ngIf="!sidebar.collapsed" 
        (click)="sidebar.collapsed = true"
    >
    </div>
    <app-sidebar #sidebar></app-sidebar>
    <div class="facturas-container" [class.blurred]="!sidebar.collapsed">
        <div class="title-menu">
            <div class="title-area">
                <h2 class="margin-title">Gesti√≥n de Facturas</h2>  
            </div>
            <div class="search-holder">
                <div class="search-container">
                    <div class="search-form">
                        <input 
                            type="text" 
                            class="search-bar" 
                            placeholder="factura" 
                            name="search"
                            [(ngModel)]="searchQuery"
                        >
                        <input 
                            type="text" 
                            name="factura" 
                            class="search-bar smallWidth"
                            placeholder="Eje"
                            [(ngModel)]="facturaSearch"
                            maxlength="4"
                            inputmode="numeric"
                            pattern="[0-9]*"
                            (input)="onEjeInput($event)"
                        />
                        <input 
                            type="text" 
                            name="Gestor" 
                            class="search-bar smallWidth"
                            placeholder="centro de gesti√≥n faltante"
                            [(ngModel)]="centroGestor"
                            maxlength="4"
                            disabled
                        />
                        <div class="more-search-options">
                            <select [(ngModel)]="fechaTipo">
                                <option value="" disabled selected>Fecha</option>
                                <option value="registro">Registro</option>
                                <option value="factura">Factura</option>
                                <option value="contable">Contable</option>
                            </select>
                            Desde
                            <input 
                                type="date" 
                                name="desde" 
                                class="fecha-dato" 
                                [(ngModel)] = "fromDate"
                            >   
                            Hasta
                            <input 
                                type="date" 
                                name="hasta" 
                                class="fecha-dato" 
                                [(ngModel)] = "toDate"
                            > 
                            <select [(ngModel)]="estadoTipo">
                                <option value="contabilizadas">Contabilizadas</option>
                                <option value="no-contabilizadas">No Contabilizadas</option>
                                <option value="aplicadas">Ptes. Aplicadas</option>
                                <option value="sin-aplicadas">Ptes. Sin aplicar</option>
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="btns">
                        <button type="button" class="search-button" (click)="filterFacturas()">Buscar</button>
                        <button type="button" class="search-button" (click)="forgetAll()">Limpiar</button>
                    </div>
                </div>
            </div>
            <div class="group-menu" (click)="toggleMenu($event)">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="menu-panel" *ngIf="showMenu">
                    <button class="download-btn" (click)="DownloadPDF(); closeMenu()">Descargar como PDF</button>
                    <button class="download-btn" (click)="DownloadCSV(); closeMenu()">Descargar como CSV</button>
                </div>
            </div>
        </div>
        <h1 class="successBtn">{{ estadoMessage }}</h1>
        <h1 class="errorBtn">{{ filterFacturaMessage }}</h1>

        <div class="facturas-list">
            <h1 class="successBtn">{{facturaMessageSuccess}}</h1>
            <div *ngIf="isLoading" class="loading-message">
                <div class="spinner"></div>
                <span>Cargando</span>
            </div>
            <table class="facturas-table">
                <thead>
                    <tr>
                        <th class="sortable resizable" (click)="toggleSort('facnum')">
                            N√∫mero Registro 
                            <span class="sort-indicator" *ngIf="sortColumn === 'facnum'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 0)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('tercod')">
                            C√≥digo Prov
                            <span class="sort-indicator" *ngIf="sortColumn === 'tercod'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 1)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('ternom')">
                            Nombre Proveedor
                            <span class="sort-indicator" *ngIf="sortColumn === 'ternom'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 2)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('ternif')">
                            NIF Prov
                            <span class="sort-indicator" *ngIf="sortColumn === 'ternif'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 3)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facfre')">
                            F.Registro
                            <span class="sort-indicator" *ngIf="sortColumn === 'facfre'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 4)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facimp')">
                            Importe total
                            <span class="sort-indicator" *ngIf="sortColumn === 'facimp'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 5)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facdoc')">
                            N√∫m. Factura
                            <span class="sort-indicator" *ngIf="sortColumn === 'facdoc'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 6)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facann')">
                            A√±o
                            <span class="sort-indicator" *ngIf="sortColumn === 'facann'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 7)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facfac')">
                            R.C.F
                            <span class="sort-indicator" *ngIf="sortColumn === 'facfac'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 8)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facdat')">
                            F.Factura
                            <span class="sort-indicator" *ngIf="sortColumn === 'facdat'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 9)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facado')">
                            ADO
                            <span class="sort-indicator" *ngIf="sortColumn === 'facado'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 10)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facfco')">
                            F.contable
                            <span class="sort-indicator" *ngIf="sortColumn === 'facfco'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 11)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('getPendingApply(p)')">
                            Pte. Aplicar
                            <span class="sort-indicator" *ngIf="sortColumn === 'getPendingApply(p)'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 12)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('cgecod')">
                            C.Gestor
                            <span class="sort-indicator" *ngIf="sortColumn === 'cgecod'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 13)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('getStaus(p.facado, p.facimp, p.faciec, p.facidi)')">
                            Estado
                            <span class="sort-indicator" *ngIf="sortColumn === 'getStaus(p.facado, p.facimp, p.faciec, p.facidi)'">{{ sortDirection === 'asc' ? '‚ñ≤' : '‚ñº' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 14)"></div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let p of paginatedFacturas">
                        <td>{{ p.facnum }}</td>
                        <td (click)="showDetails(p)" style="cursor: pointer;">{{ p.tercod }}</td>
                        <td>{{ p.ternom }}</td>
                        <td>{{ p.ternif }}</td>
                        <td>{{ p.facfre | date:'dd-MM-yyyy'}}</td>
                        <td>{{ p.facimp | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                        <td>{{ p.facdoc }}</td>
                        <td>{{ p.facann }}</td>
                        <td>{{ p.facfac }}</td>
                        <td>{{ p.facdat | date:'dd-MM-yyyy' }}</td>
                        <td>{{ p.facado }}</td>
                        <td>{{ p.facfco | date:'dd-MM-yyyy' }}</td>
                        <td>{{getPendingApply(p) | currency:'EUR':'symbol':'1.2-2':'es-ES'}}</td>
                        <td>{{ p.cgecod }}</td>
                        <td>{{ getStaus(p.facado, p.facimp, p.faciec, p.facidi) }}</td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination-controls">
                <button (click)="prevPage()" [disabled]="page === 0">Anterior</button>
                <span>P√°gina</span>
                <input
                type="number"
                min="1"
                [max]="totalPages"
                [value]="page + 1"
                (change)="goToPage($event)"
                class="pagination-input"
                />
                <span>de {{ totalPages }}</span>
                <button (click)="nextPage()" [disabled]="page + 1 >= totalPages">Siguiente</button>
            </div>
            <div class="modal-backdrop" *ngIf="selectedFacturas" (click)="closeDetails()"></div>
            <div class="display" >
                <div class="modal" *ngIf="selectedFacturas">
                    <div class="btns">
                        <div class="title-detail">
                            <h3>Detalles del Factura</h3>
                        </div>
                        <button class="guardar-btn">üíæ</button>
                        <button class="close-btn-btn" (click)="closeDetails()">‚úñ</button>
                    </div>
                    <div class="detail-container">
                        <div class="chunk-one">
                            <div class="left">
                                <p>N√∫m. Reg.</p>
                                <p>N√∫m.Factura:</p>
                                <p>R.C.F:</p>
                            </div>
                            <div class="right">
                                <div class="on-two">
                                    <textarea class="smallTextarea" [(ngModel)]="selectedFacturas.facnum"></textarea>
                                    <p>F.Contable</p>
                                    <textarea class="averageTextarea" [ngModel]="selectedFacturas.facfco | date:'dd-MM-yyyy'"></textarea>
                                </div>
                                <textarea class="tallTextarea" [(ngModel)]="selectedFacturas.facdoc"></textarea>
                                <div class="on-two">
                                    <textarea class="smallTextarea" [(ngModel)]="selectedFacturas.facfac"></textarea>
                                    <textarea class="smallTextarea" [(ngModel)]="selectedFacturas.facann" ></textarea>
                                    <textarea class="smallTextarea" [(ngModel)]="selectedFacturas.factdc"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="chunk-two">
                            <div class="left">
                                <p>Proveedor:</p>
                                <p>NIF</p>
                                <p>Fecha Factura</p>
                            </div>
                            <div class="right">
                                <div class="on-two">
                                    <textarea class="smallTextarea" [(ngModel)]="selectedFacturas.tercod"></textarea>
                                    <textarea class="tallTextarea" [(ngModel)]="selectedFacturas.ternom"></textarea>
                                </div>
                                <div class="on-two">
                                    <textarea class="averageTextarea" [(ngModel)]="selectedFacturas.ternif"></textarea>
                                    <p>C.Gestor</p>
                                    <textarea class="smallTextarea" [value]="selectedFacturas.cgecod" readonly></textarea>
                                </div>
                                <div class="on-two">
                                    <textarea class="averageTextarea" [ngModel]="selectedFacturas.facdat | date:'dd-MM-yyyy'"></textarea>
                                    <p>F.Registro</p>
                                    <textarea class="averageTextarea" [ngModel]="selectedFacturas.facfre | date:'dd-MM-yyyy'"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="chunk-three special-chunk">
                            <div class="left special-needs">
                                <p>Tipo de contrato</p>
                                <p>Criterio de puntuaci√≥n</p>
                                <p>Procedimiento de contacto</p>
                            </div>
                            <div class="right">
                                <textarea class="tallTextarea" [ngModel]="selectedFacturas.conctp"></textarea>
                                <textarea class="tallTextarea" [ngModel]="selectedFacturas.concpr"></textarea>
                                <textarea class="tallTextarea" [ngModel]="selectedFacturas.conccr"></textarea>  
                            </div>
                        </div>
                        <div class="chunk-four">
                            <div class="left">
                                <p>Forma de pago</p>
                                <p>Ordinal de pago</p>     
                            </div>
                            <div class="right">
                                <div class="on-two">
                                    <textarea class="smallTextarea" [ngModel]="selectedFacturas.facfpg"></textarea>
                                    <p>Tipo de pago</p>
                                    <textarea class="smallTextarea" [ngModel]="selectedFacturas.factpg"></textarea>
                                </div>
                                <div class="on-two">
                                    <textarea class="smallTextarea" [ngModel]="selectedFacturas.facopg"></textarea>
                                    <p>ADO</p>
                                    <textarea class="averageTextarea" [(ngModel)]="selectedFacturas.facado"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="chunk-five">
                            <div class="left">
                                <p>Des.Fact/ADO:</p>
                            </div>
                            <div class="right">
                                <textarea class="tallTextarea" [(ngModel)]="selectedFacturas.factxt"></textarea>
                            </div>
                        </div>
                        <div class="chunk-six">
                            <div class="left">
                                <p>Total Factura</p>
                                <p>Apl.diferencias</p>
                                <p>Descuentos</p>
                            </div>
                            <div class="right">
                                <div class="on-two">
                                    <textarea class="averageTextarea" [ngModel]="selectedFacturas.facimp | currency:'EUR':'symbol':'1.2-2':'es-ES'"></textarea>
                                    <p>Aplicado</p>
                                    <textarea class="averageTextarea" [ngModel]="selectedFacturas.faciec | currency:'EUR':'symbol':'1.2-2':'es-ES'"></textarea>
                                </div>
                                <div class="on-two">
                                    <textarea class="averageTextarea" [ngModel]="selectedFacturas.facidi | currency:'EUR':'symbol':'1.2-2':'es-ES'"></textarea>
                                    <p>Pte.Apli</p>
                                    <textarea class="averageTextarea" [value]="getPendingApply(selectedFacturas) | currency:'EUR':'symbol':'1.2-2':'es-ES'" readonly></textarea>
                                </div>
                                <textarea class="averageTextarea" [value]="selectedFacturas.facdto | currency:'EUR':'symbol':'1.2-2':'es-ES'" readonly></textarea>
                            </div>
                        </div>
                        <div class="observ">
                            <p>Observaciones:</p>
                            <textarea [(ngModel)]="selectedFacturas.facobs"></textarea>
                        </div>
                    </div>
                    <div class="more-detail-container">
                        <div class="tabs" role="tablist" aria-label="Detalle tabs">
                            <button
                                class="tab-btn"
                                role="tab" 
                                type="button"
                                [class.active]="detailView === 'Albaranes'"
                                (click)="detailView = 'Albaranes'"
                            >
                                Albaranes
                            </button>
                            <button 
                                class="tab-btn"
                                role="tab" 
                                type="button"
                                [class.active]="detailView === 'Contabilizaci√≥n'"
                                (click)="detailView = 'Contabilizaci√≥n'"
                            >
                                Datos Contabilizaci√≥n
                            </button>
                        </div>
                    </div>
                    <div class="more-details">
                        <div class="detail-grid" *ngIf="detailView === 'Albaranes'">
                            <div class="more-detail-container">
                                <div class="tabs" role="tablist" aria-label="Opciones de Albaranes">
                                    <button
                                        class="tab-btn"
                                        role="tab"
                                        type="button"
                                        [class.active]="albaranesOptio === 'albaranes'"
                                        (click)="setAlbaranesOptio('albaranes', selectedFacturas?.facnum)"
                                    >
                                        Albaranes
                                    </button>
                                    <button
                                        class="tab-btn"
                                        role="tab"
                                        type="button"
                                        [class.active]="albaranesOptio === 'aplicaciones'"
                                        (click)="setAlbaranesOptio('aplicaciones', selectedFacturas?.facnum)"
                                    >
                                        Aplicaciones
                                    </button>
                                    <button
                                        class="tab-btn"
                                        role="tab"
                                        type="button"
                                        [class.active]="albaranesOptio === 'descuentos'"
                                        (click)="setAlbaranesOptio('descuentos', selectedFacturas?.facnum)"
                                    >
                                        Descuentos
                                    </button>
                                </div>
                            </div>
                            <div class="detail-switch-second-content">
                                <ng-container [ngSwitch]="albaranesOptio">
                                    <ng-container *ngSwitchCase="'albaranes'">
                                        <h1 class="successBtn">{{moreInfoMessageSuccess}}</h1>
                                        <h1 class="errorBtn">{{moreInfoMessageError}}</h1>
                                        <div class="detail-card">
                                            <table class="albaranes-table">
                                                <thead>
                                                    <tr>
                                                        <th><strong>N√∫mero albar√°n</strong></th>
                                                        <th>Referencia</th>
                                                        <th>Fecha</th>
                                                        <th>Base imponible</th>
                                                        <th>Solicitud</th>
                                                        <th>√çndice</th>
                                                        <th>Observaciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let a of albaranes">
                                                        <td>{{ a.albnun }}</td>
                                                        <td>{{ a.albref }}</td>
                                                        <td>{{ a.albdat | date:'dd-MM-yyyy' }}</td>
                                                        <td>{{ a.albbim | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ a.solnum }}</td>
                                                        <td>{{ a.solsub }}</td>
                                                        <td>{{ a.albobs }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-container>

                                    <ng-container *ngSwitchCase="'aplicaciones'">
                                        <h1 class="successBtn">{{moreInfoMessageSuccess}}</h1>
                                        <h1 class="errorBtn">{{moreInfoMessageError}}</h1>
                                        <div class="detail-card">
                                            <table class="albaranes-table">
                                                <thead>
                                                    <tr>
                                                        <th><strong>Referencia</strong></th>
                                                        <th>Econ√≥mica</th>
                                                        <th>Importe</th>
                                                        <th>diferencias </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let a of apalicaciones">
                                                        <td>{{ a.FDEREF }}</td>
                                                        <td>{{ a.FDEECO }}</td>
                                                        <td>{{ a.FDEIMP | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ a.FDEDIF | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-container>

                                    <ng-container    *ngSwitchCase="'descuentos'">
                                        <h1 class="successBtn">{{moreInfoMessageSuccess}}</h1>
                                        <h1 class="errorBtn">{{moreInfoMessageError}}</h1>
                                        <div class="detail-card">
                                            <table class="albaranes-table">
                                                <thead>
                                                    <tr>
                                                        <th>√Årea</th>
                                                        <th>Org√°nica</th>
                                                        <th>Programa</th>
                                                        <th>Econ√≥mica</th>
                                                        <th>Base</th>
                                                        <th>% Dto</th>
                                                        <th>Importe Descuento</th>
                                                        <th>Descripci√≥n</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let d of descuentos">
                                                        <td>{{ d.FDTARE }}</td>
                                                        <td>{{ d.FDTORG }}</td>
                                                        <td>{{ d.FDTFUN }}</td>
                                                        <td>{{ d.FDTECO }}</td>
                                                        <td>{{ d.FDTBSE | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ d.FDTPRE | number:'1.1-1' }} %</td>
                                                        <td>{{ d.FDTDTO | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ d.FDTTXT }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-container>
                                </ng-container>
                            </div>
                        </div>
                        <div class="detail-grid" *ngIf="detailView === 'Contabilizaci√≥n'">
                            <div class="detail-card">
                                <h4>Later</h4>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>