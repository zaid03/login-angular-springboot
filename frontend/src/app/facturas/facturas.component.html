<div class="facturas-page">
    <div 
        class="sidebar-backdrop" 
        *ngIf="!sidebar.collapsed" 
        (click)="sidebar.collapsed = true"
    >
    </div>
    <app-sidebar #sidebar></app-sidebar>
    <div class="facturas-container" [class.blurred]="!sidebar.collapsed">
        <div class="title-menu">
            <div class="title-area">
                <h2 class="margin-title">Gestión de Facturas</h2>  
            </div>
            <div class="search-holder">
                <div class="search-container">
                    <div class="search-form">
                        <input 
                            type="text" 
                            class="search-bar" 
                            placeholder="factura" 
                            name="search"
                            [(ngModel)]="searchQuery"
                        >
                        <input 
                            type="text" 
                            name="factura" 
                            class="search-bar smallWidth"
                            placeholder="Eje"
                            [(ngModel)]="facturaSearch"
                            maxlength="4"
                            inputmode="numeric"
                            pattern="[0-9]*"
                            (input)="onEjeInput($event)"
                        />
                        <input 
                            type="text" 
                            name="Gestor" 
                            class="search-bar smallWidth"
                            placeholder="centro de gestión faltante"
                            [(ngModel)]="centroGestor"
                            maxlength="4"
                            disabled
                        />
                        <div class="more-search-options">
                            <select [(ngModel)]="fechaTipo">
                                <option value="" disabled selected>Fecha</option>
                                <option value="registro">Registro</option>
                                <option value="factura">Factura</option>
                                <option value="contable">Contable</option>
                            </select>
                            Desde
                            <input 
                                type="date" 
                                name="desde" 
                                class="fecha-dato" 
                                [(ngModel)] = "fromDate"
                            >   
                            Hasta
                            <input 
                                type="date" 
                                name="hasta" 
                                class="fecha-dato" 
                                [(ngModel)] = "toDate"
                            > 
                            <select [(ngModel)]="estadoTipo">
                                <option value="contabilizadas">Contabilizadas</option>
                                <option value="no-contabilizadas">No Contabilizadas</option>
                                <option value="aplicadas">Ptes. Aplicadas</option>
                                <option value="sin-aplicadas">Ptes. Sin aplicar</option>
                                <option value="">Todas</option>
                            </select>
                        </div>
                    </div>
                    <div class="btns">
                        <button type="button" class="search-button" (click)="filterFacturas()">Buscar</button>
                        <button type="button" class="search-button" (click)="forgetAll()">Limpiar</button>
                    </div>
                </div>
            </div>
            <div class="group-menu" (click)="toggleMenu($event)">
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="dot"></div>
                <div class="menu-panel" *ngIf="showMenu">
                    <button class="download-btn" (click)="DownloadPDF(); closeMenu()">Descargar como PDF</button>
                    <button class="download-btn" (click)="DownloadCSV(); closeMenu()">Descargar como CSV</button>
                </div>
            </div>
        </div>
        <h1 class="successBtn">{{ estadoMessage }}</h1>
        <h1 class="errorBtn">{{ filterFacturaMessage }}</h1>

        <div class="facturas-list">
            <h1 class="successBtn">{{facturaMessageSuccess}}</h1>
            <table class="facturas-table">
                <thead>
                    <tr>
                        <th class="sortable resizable" (click)="toggleSort('facnum')">
                            Número Registro 
                            <span class="sort-indicator" *ngIf="sortColumn === 'facnum'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 0)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('tercod')">
                            Código Prov
                            <span class="sort-indicator" *ngIf="sortColumn === 'tercod'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 1)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('ternom')">
                            Nombre Proveedor
                            <span class="sort-indicator" *ngIf="sortColumn === 'ternom'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 2)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('ternif')">
                            NIF Prov
                            <span class="sort-indicator" *ngIf="sortColumn === 'ternif'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 3)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facfre')">
                            F.Registro
                            <span class="sort-indicator" *ngIf="sortColumn === 'facfre'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 4)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facimp')">
                            Importe total
                            <span class="sort-indicator" *ngIf="sortColumn === 'facimp'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 5)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facdoc')">
                            Núm. Factura
                            <span class="sort-indicator" *ngIf="sortColumn === 'facdoc'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 6)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facann')">
                            Año
                            <span class="sort-indicator" *ngIf="sortColumn === 'facann'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 7)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facfac')">
                            R.C.F
                            <span class="sort-indicator" *ngIf="sortColumn === 'facfac'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 8)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facdat')">
                            F.Factura
                            <span class="sort-indicator" *ngIf="sortColumn === 'facdat'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 9)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facado')">
                            ADO
                            <span class="sort-indicator" *ngIf="sortColumn === 'facado'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 10)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('facfco')">
                            F.contable
                            <span class="sort-indicator" *ngIf="sortColumn === 'facfco'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 11)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('getPendingApply(p)')">
                            Pte. Aplicar
                            <span class="sort-indicator" *ngIf="sortColumn === 'getPendingApply(p)'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 12)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('cgecod')">
                            C.Gestor
                            <span class="sort-indicator" *ngIf="sortColumn === 'cgecod'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 13)"></div>
                        </th>
                        <th class="sortable resizable" (click)="toggleSort('getStaus(p.facado, p.facimp, p.faciec, p.facidi)')">
                            Estado
                            <span class="sort-indicator" *ngIf="sortColumn === 'getStaus(p.facado, p.facimp, p.faciec, p.facidi)'">{{ sortDirection === 'asc' ? '▲' : '▼' }}</span>
                            <div class="resizer" (mousedown)="startResize($event, 14)"></div>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let p of paginatedFacturas">
                        <td>{{ p.facnum }}</td>
                        <td (click)="showDetails(p)" style="cursor: pointer;">{{ p.tercod }}</td>
                        <td>{{ p.ternom }}</td>
                        <td>{{ p.ternif }}</td>
                        <td>{{ p.facfre | date:'dd-MM-yyyy'}}</td>
                        <td>{{ p.facimp | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                        <td>{{ p.facdoc }}</td>
                        <td>{{ p.facann }}</td>
                        <td>{{ p.facfac }}</td>
                        <td>{{ p.facdat | date:'dd-MM-yyyy' }}</td>
                        <td>{{ p.facado }}</td>
                        <td>{{ p.facfco | date:'dd-MM-yyyy' }}</td>
                        <td>{{getPendingApply(p) | currency:'EUR':'symbol':'1.2-2':'es-ES'}}</td>
                        <td>{{ p.cgecod }}</td>
                        <td>{{ getStaus(p.facado, p.facimp, p.faciec, p.facidi) }}</td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination-controls">
                <button (click)="prevPage()" [disabled]="page === 0">Anterior</button>
                <span>Página</span>
                <input
                type="number"
                min="1"
                [max]="totalPages"
                [value]="page + 1"
                (change)="goToPage($event)"
                class="pagination-input"
                />
                <span>de {{ totalPages }}</span>
                <button (click)="nextPage()" [disabled]="page + 1 >= totalPages">Siguiente</button>
            </div>
            <div class="modal-backdrop" *ngIf="selectedFacturas" (click)="closeDetails()"></div>
            <div class="display" >
                <div class="modal" *ngIf="selectedFacturas">
                    <button class="close-btn-fct" (click)="closeDetails()">×</button>
                    <h3>Detalles de Factura</h3>

                    <div class="data">
                        <div class="left">
                            <div class="first-row">
                                <div class="first-data">
                                    <p>Núm. Reg.</p>
                                    <textarea [(ngModel)]="selectedFacturas.facnum"></textarea>
                                </div>
                                <div class="first-data">
                                    <p>F.Contable</p>
                                    <textarea [ngModel]="selectedFacturas.facfco | date:'dd-MM-yyyy'"></textarea>
                                </div>
                                <div class="first-data">
                                    <p>ADO</p>
                                    <textarea [(ngModel)]="selectedFacturas.facado"></textarea>
                                </div>  
                            </div>
                            <div class="second-row">
                                <div class="second-data">
                                    <p>R.C.F:</p>
                                    <textarea [(ngModel)]="selectedFacturas.facfac"></textarea>
                                    <textarea [(ngModel)]="selectedFacturas.facann" ></textarea>
                                    <textarea [(ngModel)]="selectedFacturas.factdc"></textarea>
                                </div>
                                <div class="second-data">
                                    <p>Núm.Factura:</p>
                                    <textarea [(ngModel)]="selectedFacturas.facdoc"></textarea>
                                </div>
                            </div>
                            <div class="third-row">
                                <div class="third-data">
                                    <p>Proveedor:</p>
                                    <textarea [(ngModel)]="selectedFacturas.tercod"></textarea>
                                    <textarea class="width" [(ngModel)]="selectedFacturas.ternom"></textarea>
                                </div>
                            </div>
                            <div class="fourth-row">
                                <div class="fourth-data">
                                    <p>NIF</p>
                                    <textarea [(ngModel)]="selectedFacturas.ternif"></textarea>
                                </div>
                                <div class="fourth-data">
                                    <p>Fecha Factura</p>
                                    <textarea [ngModel]="selectedFacturas.facdat | date:'dd-MM-yyyy'"></textarea>
                                </div>
                                <div class="fourth-data">
                                    <p>C.Gestor</p>
                                    <textarea [value]="selectedFacturas.cgecod" readonly></textarea>
                                </div>
                            </div>
                            <div class="fifth-row">
                                <div class="fifth-data">
                                    <p style="margin-bottom: 10px;">Des.Fact/ADO:</p>
                                    <textarea [(ngModel)]="selectedFacturas.factxt"></textarea>
                                </div>
                                <div class="fifth-data">
                                    <p style="margin-bottom: 10px;">F.Registro</p>
                                    <textarea [ngModel]="selectedFacturas.facfre | date:'dd-MM-yyyy'"></textarea>
                                </div>  
                            </div>
                            <div class="sixth-row">
                                <div class="sixth-data">
                                    <p style="margin-bottom: 10px;">Tipo de contrato</p>
                                    <textarea [ngModel]="selectedFacturas.conctp"></textarea>
                                </div>
                                <div class="sixth-data">
                                    <p style="margin-bottom: 10px;">Procedimiento de contacto</p>
                                    <textarea [ngModel]="selectedFacturas.concpr"></textarea>
                                </div>
                                <div class="sixth-data">
                                    <p style="margin-bottom: 10px;">Criterio de puntuación</p>
                                    <textarea [ngModel]="selectedFacturas.conccr"></textarea>
                                </div>
                            </div>
                            <div class="seventh-row">
                                <div class="seventh-data">
                                    <p style="margin-bottom: 10px;">Forma de pago</p>
                                    <textarea [ngModel]="selectedFacturas.facfpg"></textarea>
                                </div>
                                <div class="seventh-data">
                                    <p style="margin-bottom: 10px;">Ordinal de pago</p>
                                    <textarea [ngModel]="selectedFacturas.facopg"></textarea>
                                </div>
                                <div class="seventh-data">
                                    <p style="margin-bottom: 10px;">Tipo de pago</p>
                                    <textarea [ngModel]="selectedFacturas.factpg"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="right">
                            <div class="eighth-data margin">
                                <p style="margin-bottom: 10px;">Total Factura</p>
                                <textarea [ngModel]="selectedFacturas.facimp | currency:'EUR':'symbol':'1.2-2':'es-ES'"></textarea>
                            </div>
                            <div class="ninth-data margin">
                                <p>Aplicado:</p>
                                <textarea [ngModel]="selectedFacturas.faciec | currency:'EUR':'symbol':'1.2-2':'es-ES'"></textarea>
                            </div>
                            <div class="tenth-data margin">
                                <p>Apl. diferencias:</p>
                                <textarea [ngModel]="selectedFacturas.facidi | currency:'EUR':'symbol':'1.2-2':'es-ES'"></textarea>
                            </div>
                            <div class="eleventh-data margin">
                                <p>Pte.Aplicar</p>
                                <textarea [value]="getPendingApply(selectedFacturas) | currency:'EUR':'symbol':'1.2-2':'es-ES'" readonly></textarea>
                            </div>
                            <div class="twelfth-data margin">
                                <p>Descuentos</p>
                                <textarea [value]="selectedFacturas.facdto | currency:'EUR':'symbol':'1.2-2':'es-ES'" readonly></textarea>
                            </div>
                            <div class="thirteenth-data margin">
                                <p>Observaciones:</p>
                                <textarea [(ngModel)]="selectedFacturas.facobs"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="more-details">
                        <div class="detail-switch"> 
                            <button type="button"
                                    [class.active]="detailView === 'Albaranes'"
                                    (click)="detailView = 'Albaranes'">
                                Albaranes
                            </button>
                            <button type="button"
                                    [class.active]="detailView === 'Contabilización'"
                                    (click)="detailView = 'Contabilización'">
                                Datos Contabilización
                            </button>
                        </div>

                        <div class="detail-grid" *ngIf="detailView === 'Albaranes'">
                            <div class="detail-switch-second">
                                <button type="button"
                                        [class.active]="albaranesOptio === 'albaranes'"
                                        (click)="setAlbaranesOptio('albaranes', selectedFacturas?.facnum)">
                                    Albaranes
                                </button>
                                <button type="button"
                                        [class.active]="albaranesOptio === 'aplicaciones'"
                                        (click)="setAlbaranesOptio('aplicaciones', selectedFacturas?.facnum)">
                                    Aplicaciones
                                </button>
                                <button type="button"
                                    [class.active] = "albaranesOptio === 'descuentos'"
                                    (click)="setAlbaranesOptio('descuentos', selectedFacturas?.facnum)">
                                    Descuentos
                                </button>
                            </div>

                            <div class="detail-switch-second-content">
                                <ng-container [ngSwitch]="albaranesOptio">
                                    <ng-container *ngSwitchCase="'albaranes'">
                                        <h1 class="successBtn">{{moreInfoMessageSuccess}}</h1>
                                        <h1 class="errorBtn">{{moreInfoMessageError}}</h1>
                                        <div class="detail-card">
                                            <table class="albaranes-table">
                                                <thead>
                                                    <tr>
                                                        <th><strong>Número albarán</strong></th>
                                                        <th>Referencia</th>
                                                        <th>Fecha</th>
                                                        <th>Base imponible</th>
                                                        <th>Solicitud</th>
                                                        <th>Índice</th>
                                                        <th>Observaciones</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let a of albaranes">
                                                        <td>{{ a.albnun }}</td>
                                                        <td>{{ a.albref }}</td>
                                                        <td>{{ a.albdat | date:'dd-MM-yyyy' }}</td>
                                                        <td>{{ a.albbim | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ a.solnum }}</td>
                                                        <td>{{ a.solsub }}</td>
                                                        <td>{{ a.albobs }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-container>

                                    <ng-container *ngSwitchCase="'aplicaciones'">
                                        <h1 class="successBtn">{{moreInfoMessageSuccess}}</h1>
                                        <h1 class="errorBtn">{{moreInfoMessageError}}</h1>
                                        <div class="detail-card">
                                            <table class="albaranes-table">
                                                <thead>
                                                    <tr>
                                                        <th><strong>Referencia</strong></th>
                                                        <th>Económica</th>
                                                        <th>Importe</th>
                                                        <th>diferencias </th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let a of apalicaciones">
                                                        <td>{{ a.FDEREF }}</td>
                                                        <td>{{ a.FDEECO }}</td>
                                                        <td>{{ a.FDEIMP | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ a.FDEDIF | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-container>

                                    <ng-container    *ngSwitchCase="'descuentos'">
                                        <h1 class="successBtn">{{moreInfoMessageSuccess}}</h1>
                                        <h1 class="errorBtn">{{moreInfoMessageError}}</h1>
                                        <div class="detail-card">
                                            <table class="albaranes-table">
                                                <thead>
                                                    <tr>
                                                        <th>Área</th>
                                                        <th>Orgánica</th>
                                                        <th>Programa</th>
                                                        <th>Económica</th>
                                                        <th>Base</th>
                                                        <th>% Dto</th>
                                                        <th>Importe Descuento</th>
                                                        <th>Descripción</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let d of descuentos">
                                                        <td>{{ d.FDTARE }}</td>
                                                        <td>{{ d.FDTORG }}</td>
                                                        <td>{{ d.FDTFUN }}</td>
                                                        <td>{{ d.FDTECO }}</td>
                                                        <td>{{ d.FDTBSE | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ d.FDTPRE | number:'1.1-1' }} %</td>
                                                        <td>{{ d.FDTDTO | currency:'EUR':'symbol':'1.2-2':'es-ES' }}</td>
                                                        <td>{{ d.FDTTXT }}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </ng-container>
                                </ng-container>
                            </div>
                        </div>
                        <div class="detail-grid" *ngIf="detailView === 'Contabilización'">
                            <div class="detail-card">
                                <h4>Later</h4>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>